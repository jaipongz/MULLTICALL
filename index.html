<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Group Call Test</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        video {
            width: 100%;
            height: auto;
            background-color: black;
            border-radius: 10px;
        }

        #local-video {
            border: 2px solid green;
        }

        #controls {
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="mt-3">Group Call Test</h2>

        <div id="video-grid">
            <video id="local-video" autoplay muted></video>
        </div>

        <div id="controls">
            <input type="text" id="room-id" placeholder="Room ID" class="form-control mt-2" value="test-room" />
            <input type="text" id="user-id" placeholder="Your Name" class="form-control mt-2" value="user-1" />

            <button id="create-room-btn" class="btn btn-primary mt-2">Create Room</button>
            <button id="join-room-btn" class="btn btn-success mt-2">Join Room</button>
            <button id="leave-room-btn" class="btn btn-danger mt-2" disabled>Leave Room</button>
            <button id="toggle-mic-btn" class="btn btn-warning mt-2">üîá ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå</button>
        </div>

    </div>

    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        const socket = io('https://api-m-health.d.orisma.com'); // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô URL ‡πÄ‡∏ã‡∏¥‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const videoGrid = document.getElementById('video-grid');
        const localVideo = document.getElementById('local-video');
        let localStream;
        let currentRoomId = null;

        const peerConnections = {};
        const videoElements = {};

        document.getElementById('create-room-btn').onclick = () => {
            const roomId = document.getElementById('room-id').value.trim();
            if (!roomId) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Room ID');
            socket.emit('create-room', { roomId });
        };

        socket.on('room-created', ({ roomId }) => {
            alert(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á ${roomId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        });

        socket.on('room-exists', ({ roomId }) => {
            alert(`‡∏´‡πâ‡∏≠‡∏á ${roomId} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`);
        });

        socket.on('room-not-found', ({ roomId }) => {
            alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á ${roomId}`);
        });
        document.getElementById('toggle-mic-btn').onclick = () => {
            toggleMic();
            document.getElementById('toggle-mic-btn').innerText = isMuted ? 'üîá ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå' : 'üé§ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå';
        };
        document.getElementById('join-room-btn').onclick = () => {
            const roomId = document.getElementById('room-id').value.trim();
            const userId = document.getElementById('user-id').value.trim();
            if (!roomId || !userId) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Room ID ‡πÅ‡∏•‡∏∞ User ID');

            if (!localStream) {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(stream => {
                        localStream = stream;
                        localVideo.srcObject = stream;
                        joinRoom(roomId, userId);
                    })
                    .catch(err => {
                        console.error('Media error:', err);
                        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡∏Ñ‡πå‡πÑ‡∏î‡πâ');
                    });
            } else {
                joinRoom(roomId, userId);
            }
        };

        function joinRoom(roomId, userId) {
            socket.emit('join-call', { roomId, userId });
            currentRoomId = roomId;
            document.getElementById('leave-room-btn').disabled = false;
        }

        document.getElementById('leave-room-btn').onclick = () => {
            if (!currentRoomId) return;
            socket.emit('leave-call', { roomId: currentRoomId });
            currentRoomId = null;
            document.getElementById('leave-room-btn').disabled = true;

            // ‡∏õ‡∏¥‡∏î peer connections ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á video streams
            Object.values(peerConnections).forEach(pc => pc.close());
            Object.values(videoElements).forEach(video => video.remove());
            for (const key in peerConnections) delete peerConnections[key];
            for (const key in videoElements) delete videoElements[key];

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                localVideo.srcObject = null;
            }
        };

        socket.on('user-joined', ({ socketId, userId }) => {
            console.log('User joined:', socketId, userId);

            if (socketId === socket.id) return; // ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            if (peerConnections[socketId]) return; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≥

            const pc = createPeerConnection(socketId);
            peerConnections[socketId] = pc;

            if (localStream) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }

            pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .then(() => {
                    socket.emit('signal', {           // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å group-signal
                        type: 'offer',                // ‡πÄ‡∏û‡∏¥‡πà‡∏° type ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó signaling
                        roomId: currentRoomId,
                        to: socketId,
                        from: socket.id,
                        userId: document.getElementById('user-id').value,
                        data: pc.localDescription
                    });
                });

            createVideoFrame(socketId, userId);
        });


        function createVideoFrame(socketId, userName) {
            if (videoElements[socketId]) return;

            const container = document.createElement('div');
            container.style.position = 'relative';
            container.style.border = '2px solid gray';
            container.style.borderRadius = '10px';
            container.style.overflow = 'hidden';
            container.style.marginBottom = '5px';

            const video = document.createElement('video');
            video.autoplay = true;
            video.style.width = '100%';
            video.style.height = 'auto';

            const nameLabel = document.createElement('div');
            nameLabel.innerText = userName;
            nameLabel.style.position = 'absolute';
            nameLabel.style.bottom = '5px';
            nameLabel.style.left = '5px';
            nameLabel.style.backgroundColor = 'rgba(0,0,0,0.5)';
            nameLabel.style.color = 'white';
            nameLabel.style.padding = '2px 5px';
            nameLabel.style.borderRadius = '3px';
            nameLabel.style.fontSize = '12px';

            const micIcon = document.createElement('span');
            micIcon.innerText = 'üé§';
            micIcon.style.position = 'absolute';
            micIcon.style.top = '5px';
            micIcon.style.right = '5px';
            micIcon.style.backgroundColor = 'rgba(0,0,0,0.5)';
            micIcon.style.color = 'white';
            micIcon.style.padding = '2px 5px';
            micIcon.style.borderRadius = '3px';
            micIcon.style.fontSize = '12px';
            micIcon.id = `mic-status-${socketId}`;

            container.appendChild(video);
            container.appendChild(nameLabel);
            container.appendChild(micIcon);
            videoGrid.appendChild(container);

            videoElements[socketId] = video;
        }

        socket.on('user-left', ({ socketId }) => {
            if (peerConnections[socketId]) {
                peerConnections[socketId].close();
                delete peerConnections[socketId];
            }
            if (videoElements[socketId]) {
                videoElements[socketId].parentElement.remove();
                delete videoElements[socketId];
            }
        });

        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡∏Ñ‡πå‡∏à‡∏≤‡∏Å server
        socket.on('mic-status', ({ socketId, isMuted }) => {
            const micIcon = document.getElementById(`mic-status-${socketId}`);
            if (micIcon) {
                micIcon.style.backgroundColor = isMuted ? 'red' : 'rgba(0,0,0,0.5)';
                micIcon.innerText = isMuted ? 'üîá' : 'üé§';
            }
        });

        let isMuted = false;

        function toggleMic() {
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => track.enabled = !isMuted);
            socket.emit('mic-status', { roomId: currentRoomId, isMuted });
        }

        socket.on('current-members', (members) => {
            console.log('Current members in room:', members);
            members.forEach(socketId => {
                if (socketId === socket.id) return; // ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á connection ‡πÑ‡∏õ‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
                if (!peerConnections[socketId]) {
                    const pc = createPeerConnection(socketId);
                    peerConnections[socketId] = pc;
                    if (localStream) {
                        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                    }
                }
            });
        });


        socket.on('signal', async ({ type, from, data }) => {
            let pc = peerConnections[from];
            if (!pc) {
                pc = createPeerConnection(from);
                peerConnections[from] = pc;
                if (localStream) {
                    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                }
            }

            try {
                if (type === 'offer') {
                    await pc.setRemoteDescription(new RTCSessionDescription(data));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    socket.emit('signal', {
                        type: 'answer',
                        roomId: currentRoomId,
                        to: from,
                        from: socket.id,
                        data: answer
                    });
                } else if (type === 'answer') {
                    await pc.setRemoteDescription(new RTCSessionDescription(data));
                } else if (type === 'ice-candidate') {
                    await pc.addIceCandidate(new RTCIceCandidate(data));
                }
            } catch (err) {
                console.error('Error handling signal', err);
            }
        });

        socket.on('user-left', ({ socketId }) => {
            console.log('User left:', socketId);
            if (peerConnections[socketId]) {
                peerConnections[socketId].close();
                delete peerConnections[socketId];
            }
            if (videoElements[socketId]) {
                videoElements[socketId].remove();
                delete videoElements[socketId];
            }
        });

        function createPeerConnection(socketId) {

            const iceConfiguration = {
                iceServers: [
                    {
                        urls: 'turn:10.91.2.77:3478 ',
                        username: 'optional-username', // Replace with actual username if needed
                        credential: 'auth-token'       // Replace with the actual credential/token
                    },
                    {
                        urls: 'stun:stun.l.google.com:19302'
                    }
                ],
                // iceTransportPolicy: 'all',
                iceTransportPolicy: 'relay',
                bundlePolicy: 'balanced',
                rtcpMuxPolicy: 'require',
                iceCandidatePoolSize: 0
            };
            const pc = new RTCPeerConnection(iceConfiguration);

            pc.onicecandidate = event => {
                if (event.candidate) {
                    console.log('EVENT CANDIDATE =>', event.candidate);
                    console.log('from ->', socket.id);
                    console.log('to ->', socketId);
                    console.log('current room ->', currentRoomId);
                    socket.emit('signal', {            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å group-signal
                        type: 'ice-candidate',
                        roomId: currentRoomId,
                        to: socketId,
                        from: socket.id,
                        data: event.candidate
                    });
                }
            };


            pc.oniceconnectionstatechange = () => {
                console.log(`ICE Connection State (${socketId}):`, pc.iceConnectionState);
            };

            pc.ontrack = event => {
                if (!videoElements[socketId]) {
                    const video = document.createElement('video');
                    video.autoplay = true;
                    videoElements[socketId] = video;
                    videoGrid.appendChild(video);
                }
                videoElements[socketId].srcObject = event.streams[0];
            };

            return pc;
        }
    </script>
</body>

</html>